# 账户抽象与ERC-4337

# 概述
之前以太坊的热潮是关于账户抽象。为什么？因为托管钱包（例如，外部拥有账户（EOA））难以管理，用户体验可能很糟糕。目前存在一些智能合约钱包（例如 Argent、Safe），但它们不像我们希望的那样具有互操作性，并且仍然需要依赖 EOA 来提交交易。在本指南中，我们将讨论 ERC-4337，这是一个旨在解决钱包用户体验问题的以太坊改进提案（EIP）。

# 什么是账户抽象 / ERC-4337？
是一个旨在解决上述挑战的 EIP 草案。然而，ERC-4337 并不是第一个试图解决这些挑战的 EIP。它最早在 2016 年通过 EIP-86（交易来源和签名的抽象）引起关注，然后在 2020 年再次通过 EIP-2938 和 EIP-3074 引起关注。可以说，开发者们自以太坊早期以来一直在尝试解决这个问题，但大多数这些 EIP 都需要对以太坊协议进行核心更改，因此未能成功。

账户抽象，即 ERC-4337，是一种解决当前以太坊钱包用户体验的新方法。账户抽象充当“智能合约钱包”，用户可以在不拥有自己的私钥或无需维护以太币以支付交易费用的情况下与以太坊网络进行交互。它使用替代内存池（也称为 Alt Mempool）设计来接受和解释消息（我们稍后会详细讨论）以促进这些交易。

账户抽象打开了以下大门：

多操作：与智能合约的某些交互涉及多个步骤，并需要多个交易。例如，当与 DeFi 协议交互时，用户可能需要批准代币转移，然后存入该代币，然后执行其他操作。每个步骤都需要由 EOA 单独发起，这是一个繁琐且可能成本高昂的过程。ERC-4337 通过引入一种称为“UserOperation”的新交易类型来解决这个问题。UserOperations 允许用户定义应作为单个操作的一部分执行的一系列步骤。然后，这些步骤由 EntryPoint 合约执行，该合约充当用户的代理。不要担心 UserOperation 和 EntryPoint，我们很快就会详细讨论它们。
多签名：ERC-4337 允许多签名功能，为不同的用例打开了大门，例如社交恢复（例如，通过你信任的同行恢复账户）、治理安全（例如，未经授权的交易）等。
自定义签名方案：允许使用替代签名方案。以太坊目前使用 ECDSA 进行交易签名，尽管它是安全的并且广泛使用，但额外的签名方案为不同的用例打开了大门，可能会提高互操作性和用户体验。
Gas 成本灵活性：ERC-4337 支持“赞助交易”，即其他人可以支付 gas 费用，从而在交易费用处理方面提供更大的灵活性。
可升级性：ERC-4337 标准使用代理合约，使其可以“升级”。这可以允许在不中断生态系统内互操作性的情况下添加新功能和修复错误。

# ERC-4337 的关键组件
现在让我们更深入地了解 ERC-4337 的关键组件：

## UserOperations 
- 将 UserOperations 视为你提供给以太坊账户的“待办事项列表”。这个“待办事项列表”可以包括转账、与智能合约交互，甚至是多个操作的组合。在当前的以太坊模型中，你需要手动执行此列表中的每个项目，每次交易一次，但在 ERC-4337 中，你可以将这些操作捆绑在一起，签署它，然后让以太坊网络处理其余部分。UserOperations 的字段结构与当前使用的以太坊交易类似，但包括一些与 ERC-4337 相关的逻辑更新。
![alt text](wallet/image-4.png)
## Bundlers 
- 在创建你的 UserOperation 之后，你需要有人将其放入以太坊网络中。这就是 Bundlers 的作用。Bundlers 可以被视为促进者。他们是验证者或 MEV（最大可提取价值）搜索者，他们会将你的 UserOperation 与其他人的捆绑在一起，并将它们一起提交到以太坊网络。
## EntryPoint 
- EntryPoint 是一个智能合约，充当以太坊网络的守门人。一旦 Bundlers 提交了 UserOperations，EntryPoint 负责解包并执行所有操作。如果它遇到任何失败的操作，它可以回滚（或撤销）该操作的所有操作，确保交易的完整性和可靠性。
![alt text](wallet/image-5.png)
## Contract Account 
- Contract Account 就像你在以太坊网络上的自动化助手。与需要手动发起每个操作的常规账户（EOA）不同，Contract Accounts 可以根据它们接收到的指令（例如来自 UserOperation 的指令）自动执行操作。它们可以与其他合约交互，持有和管理资产，甚至可以根据其编程逻辑做出决策。这使它们成为自动化和简化以太坊上复杂交易的强大工具。
  ![alt text](wallet/image-6.png)
  ![alt text](wallet/image-7.png)
## Paymaster 
- 这是一个可选的实体（即智能合约），可以代表你的交易支付（赞助）交易费用。它同意向 Bundler（即向网络提交交易的实体）报销 gas 费用。Paymaster 支付费用的具体时间和方式可以在智能合约中定义。
Aggregators - 这是一个可选的智能合约，它与 Contract Account 交互，帮助它验证来自多个 UserOperations 的签名。

总之，ERC-4337 标准为以太坊架构引入了几个新组件，每个组件在交易过程中都扮演着重要角色。

# gas代付的流程
- EntryPoint 执行：
  - 验证阶段:
    - 调用钱包验证:
      - EntryPoint 调用 validateUserOp，检查签名是否正确。返回0表示有效。
    - 调用 Paymaster 验证:
      - EntryPoint 调用 validatePaymasterUserOp，Paymaster 确认代付。
      - 估算Gas成本（比如0.002ETH）
    - 执行阶段：
      - EntryPoint 调用钱包的 execute
      - 转账完成，其他人收到 1 ETH
      - Paymaster 支付 Gas（0.002 ETH 从它余额扣除）。

## 细节
validatePaymasterUserOp， Paymaster的方法，可以自定义愿意给谁代付，方法实现自定义校验逻辑。
