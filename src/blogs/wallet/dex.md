# 一.业务概述
- 批量地址生成
- 充值
- 提现
- 归集
- 热转冷
- 冷转热
- 回滚
- 链路风控
- RPC节点搭建，负载均衡
  
## 整体架构设计
![alt text](wallet/image-35.png)  
注意：实际未使用TEE环境和KMS服务，也没有风控链路。  

# 二.批量地址生成
![alt text](wallet/image-25.png)  
整体架构这样设计应该没有问题，具体细节业务流程可以根据需要变动，比如签名机可以放在tee环境，或者hsm.
注意同源链可以用同一个地址，发交易的时候注意nonce问题就行。
具体生成多少个地址够用呢？ 这个看具体业务来，多了浪费少了需要频繁操作。建议可以生成一个月的用量

# 三.充值业务
## 一般交易所支持的资产
- native token
- token
- NFT

## 充值业务时序图
![alt text](wallet/image-26.png)

## 加入风控
如果比较有实力或者很在乎安全性，往往整个流程会加入风控  
![alt text](wallet/image-27.png)  

风控的作用：
1.给地址打标签，校验是否为黑、灰地址充值
2.防止内部系统作恶，它没有发交易的能力，但是监督和拦截业务层和钱包层以及签名机作恶

# 四.提现业务流程
1. 用户发起一笔提现，提现交易到达业务
2. 业务层将提现的数据推到钱包，同时也需要推给链路风控(如果有的话)
3. 组装签名所需要的参数，构建待签名交易32位Message Hash(如果是ECDSA),发送签名机之前还需要调用链路风控(如何有的话)验证交易是否合法。
4. 若风控校验合法，将待签名message hash递给签名机进行签名，签名机调取风控验证，验证之后进行签名，签名完成之后返回signature
5. 钱包使用signature和交易信息构建完整的交易，将交易发送区块网络，更新数据的状态
6. 扫链任务扫到这笔交易，from地址是热钱包地址，to地址交易所外部地址，将交易发送到风控层进行验证，验证通过之后将交易的状态更新为成功，并通知业务层提现成功。（注意，提现业务没有确认位的说法，失败了用户再来提一次，或者钱包层提高手续费发起重试）
   
# 五.归集的业务
1. 为什么需要归集？
我刚入这一行也纳闷，要归集干什么，后面做了一段时间之后感觉这是必要的，有几个原因：
- 方便资产管理：资金分散在用户地址里面，是混乱的不可控的。做了归集之后方便用户提现，资金结算和对账等操作。
- 资金散落在很多地址里面，提高了风险，地址多私钥泄露的概率就更大，安全系数比较低，造成的资金损失就大
2. 什么样的链可以不需要归集？
- 有些链是带tag或者memo，在充值的时候需要写入用户的标识字符，然后直接充值到公司归集地址，到时候通知业务层的时候根据tag来批量用户就行。这里可以省gas费，实测目前很多大交易所都是这么干的
3. 归集的业务细节
- 用户充值是有最小充值限制的，只有用户充值大于这个值，我们进行归集，如果用户充值小于这个值，一般就不给他入账了。
- 如果多次小于最小金额充值，最终达到最小金额了呢？看产品爸爸怎么说。
4. 归集的业务流程  
![alt text](wallet/image-28.png)  
手续费下发的话，交易所不是亏了吗？哈哈想多了，羊毛出在羊身上的，在用户提现的时候给他扣回来。

# 六.热转冷和冷转热业务流程
- 当热钱包金额大于一定数量，需要从热钱包转到冷钱包  
from地址：热钱包地址  
to地址：冷钱包地址  
当交易的热钱包金额小于一定数量，需要从冷钱包地址转到热钱包地址
from地址：冷钱包地址
to地址：热钱包地址

网上查到有资料和CTO说，某些交易所还有温钱包，温钱包一般是一个半联网状态，需要使用的时候就联网，不需要使用的时候就断网，一般是一个钱包的core developer管理的多签钱包，每个人持有一个Leder钱包  

# 七.回滚业务
回滚业务由链的回滚导致，链上发生回滚，交易钱包系统也要跟着回滚  
- db---> latestBlockNumber  
- chain--->chainLatestBlockNumber  
Db  里面的 latestBlockNumber 比链上 chainLatestBlockNumber 大的时候就说明链上发生了区块回滚  
在钱包里面充值的交易有一个确认位，如果大于这个确认位之后区块发生，相关的充值交易处理就处理资损失  
![alt text](wallet/image-29.png)  
## 什么情况下会发生？
- 链本身发生回滚或者深度的重组
- 链在什么情况下会发生回滚，以 BTC，ETC 等链做为例子  
- ![alt text](wallet/image-30.png)  
- ETC 这个链曾经发生过超过 5000 块的回滚，确认位的设计至少是它历史曾经回滚过的区块的 1.5 倍以上
- ETH2.0 之后，ETH 确认位设置得当的话，永远不会发生回滚，因为 ETH 的区块变成 Finalized 之后就不可以回滚了
  
# 八.RPC 节点搭建，负载规则
- 公司大一点，自己构建钱包节点，每支持一个链就会搭建一个节点群，节点通过负载均衡给钱包提供 rpc 接口。
- 不过创业公司大多选择直接对接第三方
- ![alt text](wallet/image-31.png)
- 支持多少链就搭建多少节点
- 如果是垃圾链，一般搭建一到两个节点，这种链的交易量很少，主流链(比较活跃的链)节点个数会多一些
- 钱包调研人员将搭建节点方法测试完成并且自己能够搭建成功之后写成文档交给运维就行，生产的节点一般节点运维搭建
- 小公司可能是用第三方，例如：cobo 的节点，alchemy, infra, getblock 

# 九.链路风控策略
风控策略纯属个人思考，不构成线上设计意见！
## 1.地址标签
- 巨鲸钱包
  - 金额特别大
  - 名人持有钱包
- 交易所热钱包地址
  - 地址分析可以分析出来
  - 人为往交易所里面打钱，归集的地址必然是这家交易所热钱包地址
- 涉及黑产，灰产和异常
  - 异常地址：和 tornado 这样混币器交互过，定义为异常
  - 数据抓取：
    - Hook: Telegram, WhatsAPP, Line 聊天 Hook 到你所有的消息, 将消息提到一个平台，人为分析，根据上下文分析地址是否涉及到黑灰产品，如果涉及到给地址打标签为黑地址或者灰地址。
    - 直接购买数据
- ![alt text](wallet/image-32.png)

## 2. 链路风控
![alt text](wallet/image-33.png)